<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Krishna Team ‚Ä¢ Community</title>
    <style>
        :root {
            --indigo: #3b2cff;
            --teal: #08bdbd;
            --gold: #ffd166;
            --royal: #2b50ff;
            --silver: #c0c7d6;
            --purple: #8a7cfb;
            --grey: #e9edf5;
            --text: #101828;
            --muted: #667085;
            --bg: #f6f8fb;
            --card: #ffffff;
            --shadow: 0 10px 30px rgba(16, 24, 40, .08);
            --radius: 16px;
            --radius-sm: 12px;
            --banner-img: url('https://ibb.co/gF7Q2d82');
            /* Tip: paste direct image URL (ends with .jpg/.png) */
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            font-family: Poppins, Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.45
        }

        a {
            color: var(--royal);
            text-decoration: none
        }

        header {
            background: linear-gradient(90deg, #0c1028, #0c1028), var(--banner-img);
            background-size: cover;
            background-position: center;
            color: #fff;
            padding: 0;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 10
        }

        header .overlay {
            background: linear-gradient(180deg, rgba(12, 16, 40, .65), rgba(12, 16, 40, .35));
            padding: 18px 20px
        }

        header .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            letter-spacing: .3px
        }

        header .subtitle {
            font-weight: 500;
            color: #f3f4f6;
            font-size: 14px
        }

        .wrap {
            max-width: 1100px;
            margin: 0 auto;
            padding: 20px
        }

        .card {
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 18px;
            margin-bottom: 16px
        }

        .row {
            display: flex;
            gap: 16px;
            flex-wrap: wrap
        }

        .col {
            flex: 1 1 320px
        }

        .btn {
            appearance: none;
            border: 0;
            background: var(--royal);
            color: #fff;
            padding: 10px 14px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer
        }

        .btn.ghost {
            background: #fff;
            color: var(--royal);
            border: 1px solid var(--royal)
        }

        .btn.grey {
            background: #eef2ff;
            color: #2b50ff
        }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600
        }

        .badge {
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 700;
            display: inline-block
        }

        .b-admin {
            background: #e8ecff;
            color: #2b50ff
        }

        .b-leader {
            background: #fff6db;
            color: #9a7700
        }

        .b-vice {
            background: #f1f3f8;
            color: #475467
        }

        .b-advisor {
            background: #efeaff;
            color: #5b3be1
        }

        .b-member {
            background: #f2f4f7;
            color: #475467
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 14px
        }

        .member {
            background: #fff;
            border-radius: 14px;
            box-shadow: var(--shadow);
            padding: 14px
        }

        .avatar {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            object-fit: cover;
            display: block;
            background: #eef2ff
        }

        nav.tabs {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin: 12px 0
        }

        nav.tabs button {
            background: #fff;
            border: 1px solid #d0d5dd;
            color: #344054;
            border-radius: 12px;
            padding: 8px 12px;
            cursor: pointer
        }

        nav.tabs button.active {
            background: linear-gradient(90deg, #f0f3ff, #ecfffb);
            border-color: #bfc6ff;
            color: #1d222d
        }

        .muted {
            color: var(--muted)
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d0d5dd;
            border-radius: 12px;
            background: #fff
        }

        label {
            font-size: 12px;
            color: #475467;
            font-weight: 600;
            margin-bottom: 6px;
            display: block
        }

        .list {
            display: flex;
            flex-direction: column;
            gap: 12px
        }

        .notice {
            border: 1px solid #e5e7ee;
            border-radius: 14px;
            padding: 12px
        }

        .notice .title {
            font-weight: 700
        }

        .notice .meta {
            font-size: 12px;
            color: #667085
        }

        .lightbox img {
            max-width: 100%;
            border-radius: 12px
        }

        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px
        }

        .thumb {
            position: relative;
            background: #f2f4f7;
            border-radius: 12px;
            overflow: hidden
        }

        .thumb img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            display: block
        }

        .pill {
            background: #eef2ff;
            color: #2b50ff;
            border-radius: 999px;
            padding: 4px 8px;
            font-size: 12px;
            font-weight: 700
        }

        .right {
            margin-left: auto
        }

        .hidden {
            display: none
        }

        /* LOGIN FULLSCREEN */
        .auth {
            min-height: 100vh;
            display: grid;
            place-items: center;
            background: radial-gradient(1000px 520px at -10% -20%, #ecf0ff 20%, transparent), radial-gradient(1000px 520px at 110% 120%, #e6fffb 20%, transparent)
        }

        .auth .box {
            max-width: 420px;
            width: 92%;
            background: #fff;
            border-radius: 22px;
            box-shadow: var(--shadow);
            padding: 26px
        }

        .center {
            text-align: center
        }

        .title {
            font-size: 24px;
            font-weight: 800
        }

        /* Chat */
        .chat {
            height: 380px;
            overflow: auto;
            border: 1px solid #e6e8ef;
            border-radius: 14px;
            background: #fff;
            padding: 12px
        }

        .bubble {
            max-width: 70%;
            padding: 10px 12px;
            border-radius: 14px;
            margin: 6px 0;
            display: inline-block
        }

        .mine {
            background: #eef2ff;
            color: #1d2939;
            border-top-right-radius: 4px;
            float: right;
            clear: both
        }

        .theirs {
            background: #f8fafc;
            color: #1d2939;
            border-top-left-radius: 4px;
            float: left;
            clear: both
        }

        .bubble .name {
            font-weight: 700;
            font-size: 12px;
            margin-bottom: 4px
        }

        .bubble .time {
            font-size: 10px;
            color: #667085;
            margin-top: 6px
        }

        .typing {
            font-size: 12px;
            color: #667085;
            margin-top: 4px
        }

        /* Birthday highlight */
        .bday {
            border: 2px dashed #ffd166;
            background: linear-gradient(90deg, #fff8e6, #fff);
            border-radius: 16px;
            padding: 12px
        }

        .confetti {
            font-size: 20px
        }

        /* Stories */
        .stories {
            display: flex;
            gap: 10px;
            overflow: auto;
            padding: 8px 2px
        }

        .story {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px
        }

        .ring {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            padding: 2px;
            background:
                conic-gradient(var(--royal), var(--teal));
        }

        .ring.new {
            animation: pulse 1.6s infinite ease-in-out
        }

        .ring>img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            background: #fff
        }

        .story small {
            font-size: 12px;
            color: #475467
        }

        @keyframes pulse {
            0% {
                transform: scale(1)
            }

            50% {
                transform: scale(1.04)
            }

            100% {
                transform: scale(1)
            }
        }

        /* Story Viewer */
        .viewer {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50
        }

        .viewer.active {
            display: flex
        }

        .viewer .frame {
            position: relative;
            width: min(92vw, 420px);
            height: min(92vh, 740px);
            background: #000;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, .6)
        }

        .viewer img {
            width: 100%;
            height: 100%;
            object-fit: cover
        }

        .viewer .caption {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, transparent, rgba(0, 0, 0, .6));
            color: #fff;
            padding: 16px;
            font-size: 14px
        }

        .viewer .close {
            position: absolute;
            top: 8px;
            right: 8px
        }

        .viewer .tapL,
        .viewer .tapR {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 50%;
        }

        .viewer .tapL {
            left: 0
        }

        .viewer .tapR {
            right: 0
        }

        /* Footer */
        footer {
            padding: 40px 20px;
            color: #98a2b3
        }
    </style>
</head>

<body>
    <!-- LOGIN (no scroll, centered) -->
    <section id="auth" class="auth">
        <div class="box">
            <div class="center" style="margin-bottom:14px">
                <div class="title">Welcome to Krishna Team üíô</div>
                <div class="muted">Login with your <b>@ktm.in</b> username and password.</div>
            </div>
            <div>
                <label>Username (e.g., yash@ktm.in)</label>
                <input id="loginUser" placeholder="username@ktm.in" autocomplete="username" />
            </div>
            <div style="margin-top:10px">
                <label>Password</label>
                <input id="loginPass" type="password" placeholder="********" autocomplete="current-password" />
            </div>
            <div style="display:flex;align-items:center;justify-content:space-between;margin-top:14px">
                <label style="display:flex;align-items:center;gap:8px"><input id="rememberMe" type="checkbox" /> <span
                        class="muted">Remember me</span></label>
                <button class="btn ghost" id="forgotPassBtn">Forgot Password?</button>
            </div>
            <button class="btn" style="width:100%;margin-top:12px" id="loginBtn">Login</button>
            <div id="authErr" class="muted" style="margin-top:10px;color:#b42318"></div>
        </div>
    </section>

    <!-- HEADER + APP -->
    <header id="appHeader" class="hidden">
        <div class="overlay">
            <div class="wrap brand">
                <div style="display:flex;flex-direction:column">
                    <div style="font-size:18px">Krishna Team ‚Ä¢ Community</div>
                    <div class="subtitle">Memories ‚Ä¢ Celebration ‚Ä¢ Togetherness</div>
                </div>
                <div class="right" id="userMini"></div>
            </div>
        </div>
    </header>

    <main id="app" class="wrap hidden">
        <nav class="tabs" id="tabs"></nav>

        <!-- DASHBOARD -->
        <section id="page-dashboard" class="card">
            <div class="row">
                <div class="col">
                    <h3 style="margin:0 0 8px">Hello <span id="helloName">Friend</span>! Wishing you a joyful day. üôÇ
                    </h3>
                    <div class="muted">This is your home for notices, memories, stories and chat. Keep the spirit alive!
                    </div>
                </div>
                <div class="col">
                    <div class="bday" id="bdayBox">
                        <div class="confetti">üéâ</div>
                        <div id="bdayText"><strong>Birthdays</strong> will appear here.</div>
                    </div>
                </div>
            </div>

            <!-- STORIES STRIP -->
            <div class="card" style="margin-top:12px">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                    <strong>Stories</strong>
                    <div>
                        <label class="btn grey" style="margin-right:6px"><input type="file" id="addStory"
                                accept="image/*" hidden />Add Story</label>
                        <button class="btn ghost" id="storiesSettings">Settings</button>
                    </div>
                </div>
                <div id="storiesStrip" class="stories"></div>
            </div>

            <div class="row" style="margin-top:12px">
                <div class="col card">
                    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
                        <strong>Latest Notices</strong>
                        <button class="btn grey" id="gotoNotices">Open</button>
                    </div>
                    <div id="latestNotices" class="list" style="margin-top:10px"></div>
                </div>
                <div class="col card">
                    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
                        <strong>Upcoming Events</strong>
                        <button class="btn grey" id="gotoEvents">Open</button>
                    </div>
                    <div id="upcomingEvents" class="list" style="margin-top:10px"></div>
                </div>
            </div>
        </section>

        <!-- NOTICEBOARD -->
        <section id="page-notices" class="card hidden">
            <div style="display:flex;justify-content:space-between;align-items:center">
                <h3 style="margin:0">Notice Board</h3>
                <div id="noticeActions"></div>
            </div>
            <div id="noticeList" class="list" style="margin-top:10px"></div>
        </section>

        <!-- EVENTS -->
        <section id="page-events" class="card hidden">
            <div style="display:flex;justify-content:space-between;align-items:center">
                <h3 style="margin:0">Events & Albums</h3>
                <div id="eventActions"></div>
            </div>
            <div id="eventList" class="grid" style="margin-top:10px"></div>
            <section id="eventDetail" class="card hidden" style="margin-top:12px"></section>
        </section>

        <!-- MEMBERS -->
        <section id="page-members" class="card hidden">
            <h3 style="margin:0 0 12px">Members</h3>
            <div id="membersGrid" class="grid"></div>
        </section>

        <!-- CHAT -->
        <section id="page-chat" class="card hidden">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                <h3 style="margin:0">Group Chat ‚Ä¢ Krishna Team</h3>
                <span class="muted" id="typingState"></span>
            </div>
            <div id="chatBox" class="chat"></div>
            <div class="row" style="margin-top:10px">
                <div class="col" style="flex:1 1 auto"><input id="chatInput" placeholder="Write a message‚Ä¶" /></div>
                <button class="btn" id="sendMsg">Send</button>
            </div>
        </section>

        <!-- ADMIN -->
        <section id="page-admin" class="card hidden">
            <h3 style="margin:0 0 10px">Admin Panel</h3>
            <div class="row">
                <div class="col">
                    <div class="card">
                        <strong>Users & Roles</strong>
                        <div id="usersTable" style="margin-top:8px"></div>
                    </div>
                </div>
                <div class="col">
                    <div class="card">
                        <strong>Controls</strong>
                        <div class="list" style="margin-top:8px">
                            <label class="btn grey"><input type="file" id="setBanner" accept="image/*" hidden />Change
                                Top Banner</label>
                            <label class="btn grey"><input type="checkbox" id="storiesAdminsOnly" /> Allow only
                                Admin/Leader to post Stories</label>
                            <button class="btn" id="addSampleEvent">Add Sample Event</button>
                            <button class="btn ghost" id="exportData">Export Data (JSON)</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- PROFILE -->
        <section id="page-profile" class="card hidden">
            <h3 style="margin:0 0 12px">My Profile</h3>
            <div class="row">
                <div class="col" style="max-width:340px">
                    <img id="pfp" class="avatar" alt="avatar" />
                    <div style="margin-top:8px"><label class="btn grey"><input type="file" id="pfpUpload"
                                accept="image/*" hidden />Upload Photo</label></div>
                    <div style="margin-top:8px"><strong id="pName">‚Äî</strong></div>
                    <div class="muted" id="pRole">‚Äî</div>
                </div>
                <div class="col">
                    <label>Bio</label>
                    <textarea id="pBio" rows="4" placeholder="Write something about you‚Ä¶"></textarea>
                    <div style="display:flex;gap:8px;margin-top:8px">
                        <div style="flex:1">
                            <label>Birthday (DD-MM)</label>
                            <input id="pDob" placeholder="e.g., 11-09" />
                        </div>
                        <div style="flex:1">
                            <label>Language</label>
                            <select id="pLang">
                                <option value="en">English</option>
                                <option value="hi">Hindi</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn" style="margin-top:10px" id="saveProfile">Save Profile</button>
                </div>
            </div>
        </section>

    </main>

    <!-- STORY VIEWER -->
    <div id="viewer" class="viewer">
        <div class="frame">
            <img id="viewerImg" alt="story" />
            <div class="caption" id="viewerCap"></div>
            <button class="btn ghost close" id="viewerClose">Close</button>
            <div class="tapL" id="tapL"></div>
            <div class="tapR" id="tapR"></div>
        </div>
    </div>

    <footer class="center">Built with ‚ù§Ô∏è for the Krishna Team family</footer>

    <script>
        // --- Seed users (migrated to @ktm.in) ---
        const seedUsers = [
            { name: "Chetna", username: "chetna@ktm.in", role: "former_leader", badges: ["Former Leader"], password: "P4n7xQ2e" },
            { name: "Yash", username: "yash@ktm.in", role: "admin", badges: ["Founder", "Admin", "Former Leader"], password: "R8m2Kq5z" },
            { name: "Muskan", username: "muskan@ktm.in", role: "leader", badges: ["Leader"], password: "H3v9Tz1p" },
            { name: "Aman", username: "aman@ktm.in", role: "admin", badges: ["Admin", "Sachiv"], password: "S6b8Lw0n" },
            { name: "Aditi", username: "aditi@ktm.in", role: "vice", badges: ["Vice Leader"], password: "J2c7Yk4m" },
            { name: "Bhoomi", username: "bhoomi@ktm.in", role: "advisor", badges: ["Advisor"], password: "N5t1Vr8s" },
            { name: "Kanha", username: "kanha@ktm.in", role: "member", badges: ["Member"], password: "D7w3Fp6a" },
            { name: "Jatin", username: "jatin@ktm.in", role: "member", badges: ["Member"], password: "L9q4Hs2d" },
            { name: "Manan", username: "manan@ktm.in", role: "member", badges: ["Member"], password: "C1x8Ze5r" },
            { name: "Anshul", username: "anshul@ktm.in", role: "member", badges: ["Member"], password: "T2m6Pa9u" },
            { name: "Laksh", username: "laksh@ktm.in", role: "member", badges: ["Member"], password: "E4r7Nb3i" },
            { name: "Avni", username: "avni@ktm.in", role: "member", badges: ["Member"], password: "G6u1Kd8o" },
            { name: "Anjaneesh", username: "anjaneesh@ktm.in", role: "member", badges: ["Member"], password: "B5y2Wc7l" },
        ];

        // Helpers
        const qs = s => document.querySelector(s);
        const qsa = s => Array.from(document.querySelectorAll(s));
        const R = {
            roleBadge(r, extraBadges) {
                const map = { admin: 'b-admin', leader: 'b-leader', vice: 'b-vice', advisor: 'b-advisor', member: 'b-member', former_leader: 'b-member' };
                let html = `<span class="badge ${map[r] || 'b-member'}">${{
                    admin: 'Admin', leader: 'Leader', vice: 'Vice Leader', advisor: 'Advisor', member: 'Member', former_leader: 'Former Leader'
                }[r] || 'Member'}</span>`;
                (extraBadges || []).forEach(b => { html += ` <span class="badge b-member">${b}</span>` })
                return html;
            },
            dateStr(ts) { return new Date(ts).toLocaleString(); },
            id() { return Math.random().toString(36).slice(2, 10) }
        };

        // First-run seed / migration (@ktm -> @ktm.in) and clear bad data if needed
        (function seed() {
            const u = localStorage.getItem('ktm_users');
            if (!u) {
                localStorage.setItem('ktm_users', JSON.stringify(seedUsers.map(u => ({ ...u, bio: '', dob: "", lang: 'en', pfp: '' }))))
            } else {
                // migrate usernames
                try {
                    const arr = JSON.parse(u);
                    let changed = false;
                    arr.forEach(x => { if (x.username.endsWith('@ktm')) { x.username = x.username + '.in'; changed = true; } if (x.pfp === undefined) x.pfp = ''; });
                    if (changed) localStorage.setItem('ktm_users', JSON.stringify(arr));
                } catch (e) { localStorage.removeItem('ktm_users'); localStorage.setItem('ktm_users', JSON.stringify(seedUsers.map(u => ({ ...u, bio: '', dob: "", lang: 'en', pfp: '' })))); }
            }
            if (!localStorage.getItem('ktm_notices')) {
                localStorage.setItem('ktm_notices', JSON.stringify([
                    { id: R.id(), type: 'announcement', title: 'Welcome to Krishna Team!', body: 'This is our new home for notices, memories, stories and chat.', author: 'Yash', by: "yash@ktm.in", createdAt: Date.now() - 86400000, pin: true, hearts: 3, claps: 2, prays: 4 },
                ]))
            }
            if (!localStorage.getItem('ktm_events')) {
                localStorage.setItem('ktm_events', JSON.stringify([
                    { id: R.id(), name: 'Janmashtami 2025', date: '2025-08-15', cover: '', description: 'Celebration prep and cultural programs.', createdBy: 'Muskan' }
                ]))
            }
            if (!localStorage.getItem('ktm_photos')) localStorage.setItem('ktm_photos', JSON.stringify([]));
            if (!localStorage.getItem('ktm_chat')) localStorage.setItem('ktm_chat', JSON.stringify([
                { id: R.id(), by: 'muskan@ktm.in', name: 'Muskan', text: 'Jai Shree Krishna sabko! üíô', at: Date.now() - 7200000 },
                { id: R.id(), by: 'aman@ktm.in', name: 'Aman', text: 'Meeting today 7 PM near the temple.', at: Date.now() - 7100000 },
            ]));
            if (!localStorage.getItem('ktm_stories')) localStorage.setItem('ktm_stories', JSON.stringify([]));
            if (!localStorage.getItem('ktm_banner')) localStorage.setItem('ktm_banner', '');
        })();

        // State
        let currentUser = null; // {username,...}
        let currentTab = 'dashboard';
        let storyIndex = 0;

        // User helpers
        const users = () => JSON.parse(localStorage.getItem('ktm_users') || '[]');
        const saveUsers = (v) => localStorage.setItem('ktm_users', JSON.stringify(v));

        // AUTH
        function login() {
            const u = qs('#loginUser').value.trim().toLowerCase();
            const p = qs('#loginPass').value.trim();
            const arr = users();
            const foundSeed = seedUsers.find(x => x.username === u && x.password === p);
            const exists = arr.find(x => x.username === u);
            if (foundSeed && exists) {
                currentUser = exists;
                if (qs('#rememberMe').checked) localStorage.setItem('ktm_session', u)
                startApp();
            } else {
                qs('#authErr').textContent = 'Incorrect username or password. Use name@ktm.in format (e.g., yash@ktm.in).';
            }
        }
        qs('#loginBtn').addEventListener('click', login);
        qs('#loginPass').addEventListener('keydown', e => { if (e.key === 'Enter') login() });

        // Forgot Password (Admin Reset Info)
        qs('#forgotPassBtn').addEventListener('click', () => {
            alert('Forgot your login?\nPlease contact:\nYash (Admin) ‚Äî reset from Admin Panel\nAman (Sachiv) ‚Äî can also reset for you');
        });

        // Auto session
        const remembered = localStorage.getItem('ktm_session');
        if (remembered) {
            const arr = users();
            const u = arr.find(x => x.username === remembered);
            if (u) { currentUser = u; startApp(); }
        }

        // APP START
        function startApp() {
            // Set banner if any
            const banner = localStorage.getItem('ktm_banner');
            if (banner) { document.documentElement.style.setProperty('--banner-img', `url('${banner}')`); }

            qs('#auth').classList.add('hidden');
            qs('#app').classList.remove('hidden');
            qs('#appHeader').classList.remove('hidden');
            qs('#helloName').textContent = currentUser.name;
            qs('#userMini').innerHTML = `<span class="pill">${currentUser.name}</span> <button class='btn ghost' id='logoutBtn'>Logout</button>`;
            qs('#logoutBtn').addEventListener('click', () => { localStorage.removeItem('ktm_session'); location.reload(); })
            buildTabs();
            renderDashboard();
            renderNotices();
            renderEvents();
            renderMembers();
            renderChat();
            renderProfile();
        }

        function buildTabs() {
            const base = [
                { id: 'dashboard', label: 'Dashboard' },
                { id: 'notices', label: 'Noticeboard' },
                { id: 'events', label: 'Events' },
                { id: 'members', label: 'Members' },
                { id: 'chat', label: 'Chat' },
            ];
            if (['admin'].includes(currentUser.role)) base.push({ id: 'admin', label: 'Admin' });
            base.push({ id: 'profile', label: 'My Profile' });
            qs('#tabs').innerHTML = base.map(t => `<button data-tab='${t.id}' class='${currentTab === t.id ? "active" : ""}'>${t.label}</button>`).join('');
            qsa('#tabs button').forEach(b => b.addEventListener('click', () => switchTab(b.dataset.tab)));
        }

        function switchTab(id) {
            currentTab = id; buildTabs();
            qsa('main section').forEach(s => s.classList.add('hidden'));
            qs(`#page-${id}`).classList.remove('hidden');
            if (id === 'events') renderEvents();
            if (id === 'notices') renderNotices();
            if (id === 'members') renderMembers();
            if (id === 'chat') renderChat();
            if (id === 'profile') renderProfile();
            if (id === 'admin') renderAdmin();
        }

        // Dashboard
        function renderDashboard() {
            const n = JSON.parse(localStorage.getItem('ktm_notices') || '[]').slice(0, 3);
            qs('#latestNotices').innerHTML = n.map(it => noticeCard(it, true)).join('') || '<div class="muted">No notices yet.</div>';
            qs('#gotoNotices').onclick = () => switchTab('notices');
            const ev = JSON.parse(localStorage.getItem('ktm_events') || '[]');
            qs('#upcomingEvents').innerHTML = ev.map(e => `<div class='notice'><div class='title'>${e.name}</div><div class='meta'>${e.date} ‚Ä¢ by ${e.createdBy}</div><div class='muted'>${countdown(e.date)}</div></div>`).join('') || '<div class="muted">No events yet.</div>';
            // Birthday
            const list = users();
            const today = new Date(); const d = String(today.getDate()).padStart(2, '0'); const m = String(today.getMonth() + 1).padStart(2, '0');
            const todays = list.filter(u => (u.dob || '').slice(0, 5) === `${d}-${m}`);
            if (todays.length) {
                qs('#bdayText').innerHTML = `Happy Birthday, <strong>${todays.map(u => u.name).join(', ')}</strong>! May your day be full of love, devotion and joy. ‚ú®`;
            } else { qs('#bdayText').innerHTML = `No birthdays today. üéÇ`; }
            // Stories strip
            renderStoriesStrip();
        }

        function countdown(dateStr) {
            const now = new Date(); const t = new Date(dateStr);
            const diff = t - now; if (diff <= 0) return 'Today!';
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            return `${days} days left`;
        }

        // Notices
        function noticeCard(n, compact = false) {
            const reacts = `<span>‚ù§Ô∏è ${n.hearts || 0}</span> ‚Ä¢ <span>üëè ${n.claps || 0}</span> ‚Ä¢ <span>üôè ${n.prays || 0}</span>`;
            return `<div class='notice'>
        <div style='display:flex;justify-content:space-between;align-items:center'>
          <div class='title'>${n.pin ? 'üìå ' : ''}${n.title}</div>
          <div class='meta'>${R.dateStr(n.createdAt)}</div>
        </div>
        ${compact ? '' : `<div style='margin-top:6px'>${n.body || ''}</div>`}
        <div class='meta' style='margin-top:6px'>by ${n.author} ‚Ä¢ ${reacts}</div>
        <div style='display:flex;gap:6px;margin-top:8px'>
          <button class='btn grey' onclick='reactNotice("${n.id}","hearts")'>Love</button>
          <button class='btn grey' onclick='reactNotice("${n.id}","claps")'>Clap</button>
          <button class='btn grey' onclick='reactNotice("${n.id}","prays")'>Pray</button>
          ${(['admin', 'leader', 'vice', 'advisor'].includes(currentUser.role) || n.by === currentUser.username) ? `<button class='btn ghost' onclick='deleteNotice("${n.id}")'>Delete</button>` : ''}
        </div>
      </div>`
        }

        function renderNotices() {
            const list = JSON.parse(localStorage.getItem('ktm_notices') || '[]').sort((a, b) => b.createdAt - a.createdAt);
            qs('#noticeList').innerHTML = list.map(n => noticeCard(n)).join('') || '<div class="muted">No notices yet.</div>';
            const canCreate = ['admin', 'leader', 'vice', 'advisor'].includes(currentUser.role);
            qs('#noticeActions').innerHTML = canCreate ? `<button class='btn' id='newNotice'>New Notice</button>` : '';
            if (canCreate) qs('#newNotice').onclick = () => {
                const title = prompt('Notice title'); if (!title) return;
                const body = prompt('Notice body (optional)') || '';
                const pin = confirm('Pin this notice on top?');
                const list = JSON.parse(localStorage.getItem('ktm_notices') || '[]');
                list.unshift({ id: R.id(), type: 'announcement', title, body, pin, author: currentUser.name, by: currentUser.username, createdAt: Date.now(), hearts: 0, claps: 0, prays: 0 });
                localStorage.setItem('ktm_notices', JSON.stringify(list));
                renderNotices(); renderDashboard();
            }
        }

        window.reactNotice = function (id, key) {
            const list = JSON.parse(localStorage.getItem('ktm_notices') || '[]');
            const idx = list.findIndex(x => x.id === id); if (idx < 0) return;
            list[idx][key] = (list[idx][key] || 0) + 1;
            localStorage.setItem('ktm_notices', JSON.stringify(list));
            renderNotices(); renderDashboard();
        }

        window.deleteNotice = function (id) {
            if (!confirm('Delete this notice?')) return;
            const list = JSON.parse(localStorage.getItem('ktm_notices') || '[]').filter(x => x.id !== id);
            localStorage.setItem('ktm_notices', JSON.stringify(list));
            renderNotices(); renderDashboard();
        }

        // Events & Albums
        function renderEvents() {
            const list = JSON.parse(localStorage.getItem('ktm_events') || '[]');
            const canCreate = ['admin', 'leader', 'vice', 'advisor'].includes(currentUser.role);
            qs('#eventActions').innerHTML = canCreate ? `<button class='btn' id='newEvent'>Create Event</button>` : '';
            if (canCreate) qs('#newEvent').onclick = () => {
                const name = prompt('Event name'); if (!name) return;
                const date = prompt('Event date (YYYY-MM-DD)') || '';
                const desc = prompt('Description (optional)') || '';
                const list = JSON.parse(localStorage.getItem('ktm_events') || '[]');
                list.unshift({ id: R.id(), name, date, cover: '', description: desc, createdBy: currentUser.name });
                localStorage.setItem('ktm_events', JSON.stringify(list));
                renderEvents(); renderDashboard();
            }
            qs('#eventList').innerHTML = list.map(e => `
        <div class='member'>
          <div style='display:flex;justify-content:space-between;align-items:center'>
            <div><strong>${e.name}</strong><div class='muted'>${e.date}</div></div>
            <button class='btn grey' onclick='openEvent("${e.id}")'>Open</button>
          </div>
          <div class='muted' style='margin-top:8px'>${e.description || ''}</div>
        </div>
      `).join('') || '<div class="muted">No events yet.</div>';
        }

        window.openEvent = function (id) {
            const list = JSON.parse(localStorage.getItem('ktm_events') || '[]');
            const ev = list.find(x => x.id === id); if (!ev) return;
            const photos = JSON.parse(localStorage.getItem('ktm_photos') || '[]').filter(p => p.eventId === id);
            qs('#eventDetail').classList.remove('hidden');
            qs('#eventDetail').innerHTML = `
        <div style='display:flex;justify-content:space-between;align-items:center'>
          <div><strong>${ev.name}</strong><div class='muted'>${ev.date} ‚Ä¢ ${countdown(ev.date)}</div></div>
          ${['admin', 'leader', 'vice', 'advisor'].includes(currentUser.role) ? `<label class='btn grey'><input type='file' id='evUpload' accept='image/*' multiple hidden/>Upload Photos</label>` : ''}
        </div>
        <div class='gallery' style='margin-top:10px'>${photos.map(p => `<div class='thumb'><img src='${p.url}' alt='photo'/><div style='padding:6px;font-size:12px'>${p.caption || ''}</div></div>`).join('') || '<div class="muted">No photos yet.</div>'}</div>
      `;
            const up = qs('#evUpload');
            if (up) up.onchange = async (e) => {
                const files = Array.from(e.target.files || []);
                for (const f of files) {
                    const url = await readFileAsDataURL(f);
                    addPhoto(id, url, prompt('Caption for this photo?') || '');
                }
                openEvent(id);
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function readFileAsDataURL(file) { return new Promise(res => { const fr = new FileReader(); fr.onload = () => res(fr.result); fr.readAsDataURL(file); }) }

        function addPhoto(eventId, url, caption) {
            const list = JSON.parse(localStorage.getItem('ktm_photos') || '[]');
            list.push({ id: R.id(), eventId, url, caption, by: currentUser.username, at: Date.now() });
            localStorage.setItem('ktm_photos', JSON.stringify(list));
        }

        // Members
        function renderMembers() {
            const list = users();
            qs('#membersGrid').innerHTML = list.map(u => `
        <div class='member'>
          <img class='avatar' src='${u.pfp || avatarFallback(u.name)}' alt='${u.name}'/>
          <div style='margin-top:8px'><strong>${u.name}</strong></div>
          <div style='margin-top:6px'>${R.roleBadge(u.role, u.badges)}</div>
          <div class='muted' style='margin-top:6px'><code>${u.username}</code></div>
        </div>
      `).join('');
        }

        // Chat
        function renderChat() {
            const box = qs('#chatBox');
            const msgs = JSON.parse(localStorage.getItem('ktm_chat') || '[]').sort((a, b) => a.at - b.at);
            box.innerHTML = msgs.map(m => {
                const mine = m.by === currentUser.username; const cls = mine ? 'mine' : 'theirs';
                const name = mine ? 'You' : `${m.name}`;
                return `<div class='bubble ${cls}'><div class='name'>${name}</div>${m.text}<div class='time'>${new Date(m.at).toLocaleTimeString()}</div></div>`
            }).join('');
            box.scrollTop = box.scrollHeight;
        }

        qs('#sendMsg').addEventListener('click', sendMsg);
        qs('#chatInput').addEventListener('keydown', e => { if (e.key === 'Enter') sendMsg(); });

        function sendMsg() {
            const text = qs('#chatInput').value.trim(); if (!text) return;
            const list = JSON.parse(localStorage.getItem('ktm_chat') || '[]');
            list.push({ id: R.id(), by: currentUser.username, name: currentUser.name, text, at: Date.now() });
            localStorage.setItem('ktm_chat', JSON.stringify(list));
            qs('#chatInput').value = '';
            renderChat();
        }

        // Admin
        function renderAdmin() {
            if (currentUser.role !== 'admin') return;
            const list = users();
            qs('#usersTable').innerHTML = `<div style='overflow:auto'><table style='width:100%;border-collapse:collapse'><thead><tr><th style='text-align:left;padding:6px'>Name</th><th style='text-align:left;padding:6px'>Username</th><th style='text-align:left;padding:6px'>Role</th><th style='text-align:left;padding:6px'>Actions</th></tr></thead><tbody>${list.map((u, i) => `<tr><td style='padding:6px'>${u.name}</td><td style='padding:6px'><code>${u.username}</code></td><td style='padding:6px'>${u.role}</td><td style='padding:6px'><button class='btn grey' onclick='resetPass(${i})'>Reset Pass</button></td></tr>`).join('')}</tbody></table></div>`;
            qs('#addSampleEvent').onclick = () => {
                const ev = JSON.parse(localStorage.getItem('ktm_events') || '[]');
                ev.unshift({ id: R.id(), name: 'Cultural Meet', date: new Date(Date.now() + 86400000 * 10).toISOString().slice(0, 10), cover: '', description: 'Monthly coordination meet.', createdBy: currentUser.name });
                localStorage.setItem('ktm_events', JSON.stringify(ev));
                renderEvents(); renderDashboard();
            };
            qs('#exportData').onclick = () => {
                const data = {
                    users: users(), notices: JSON.parse(localStorage.getItem('ktm_notices') || '[]'), events: JSON.parse(localStorage.getItem('ktm_events') || '[]'), photos: JSON.parse(localStorage.getItem('ktm_photos') || '[]'), chat: JSON.parse(localStorage.getItem('ktm_chat') || '[]'), stories: JSON.parse(localStorage.getItem('ktm_stories') || '[]')
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'krishna_team_backup.json'; a.click();
            }
            // Toggle stories permission
            const only = localStorage.getItem('ktm_stories_only_admin') === '1';
            qs('#storiesAdminsOnly').checked = only;
            qs('#storiesAdminsOnly').onchange = (e) => { localStorage.setItem('ktm_stories_only_admin', e.target.checked ? '1' : '0'); renderStoriesStrip(); };
            // Banner change
            qs('#setBanner').onchange = async (e) => {
                const f = e.target.files?.[0]; if (!f) return;
                const url = await readFileAsDataURL(f);
                localStorage.setItem('ktm_banner', url);
                document.documentElement.style.setProperty('--banner-img', `url('${url}')`);
                alert('Top banner updated ‚úÖ');
            };
        }

        window.resetPass = function (idx) {
            if (currentUser.role !== 'admin') return;
            const arr = users();
            const u = arr[idx];
            const newPass = Math.random().toString(36).slice(2, 10);
            const si = seedUsers.findIndex(s => s.username === u.username); if (si >= 0) seedUsers[si].password = newPass;
            alert(`New password for ${u.username}:\n${newPass}`);
        }

        // Profile
        function renderProfile() {
            qs('#pName').textContent = currentUser.name;
            qs('#pRole').innerHTML = R.roleBadge(currentUser.role, currentUser.badges);
            qs('#pBio').value = currentUser.bio || '';
            qs('#pDob').value = currentUser.dob || '';
            qs('#pLang').value = currentUser.lang || 'en';
            qs('#pfp').src = currentUser.pfp || avatarFallback(currentUser.name);
        }

        qs('#pfpUpload').addEventListener('change', async (e) => {
            const f = e.target.files?.[0]; if (!f) return;
            const url = await readFileAsDataURL(f);
            const arr = users();
            const idx = arr.findIndex(u => u.username === currentUser.username);
            arr[idx].pfp = url; saveUsers(arr); currentUser = arr[idx];
            renderProfile(); renderMembers(); renderStoriesStrip();
        });

        qs('#saveProfile').addEventListener('click', () => {
            const arr = users();
            const idx = arr.findIndex(u => u.username === currentUser.username);
            arr[idx].bio = qs('#pBio').value.trim();
            arr[idx].dob = qs('#pDob').value.trim();
            arr[idx].lang = qs('#pLang').value;
            saveUsers(arr); currentUser = arr[idx];
            alert('Profile saved ‚úÖ');
            renderDashboard();
        })

        // Avatar fallback (when no real photo)
        function avatarFallback(name) {
            const initials = name.split(' ').map(x => x[0]).slice(0, 2).join('').toUpperCase();
            const svg = encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64">
          <defs>
            <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%" stop-color="#dfe4ff"/>
              <stop offset="100%" stop-color="#d7fff6"/>
            </linearGradient>
          </defs>
          <rect rx="32" ry="32" width="64" height="64" fill="url(#g)"/>
          <text x="50%" y="54%" text-anchor="middle" font-family="Inter,Arial" font-size="26" fill="#1d2939">${initials}</text>
        </svg>
      `);
            return `data:image/svg+xml,${svg}`;
        }

        // STORIES (24h)
        function getStories() {
            const all = JSON.parse(localStorage.getItem('ktm_stories') || '[]');
            const now = Date.now();
            // expire older than 24h
            const fresh = all.filter(s => now - s.at < 24 * 60 * 60 * 1000);
            if (fresh.length !== all.length) localStorage.setItem('ktm_stories', JSON.stringify(fresh));
            return fresh;
        }
        function saveStories(arr) { localStorage.setItem('ktm_stories', JSON.stringify(arr)); }

        function renderStoriesStrip() {
            const stories = getStories();
            const onlyAdmins = localStorage.getItem('ktm_stories_only_admin') === '1';
            // Permission
            const canPost = !onlyAdmins || ['admin', 'leader'].includes(currentUser.role);
            qs('#addStory').disabled = !canPost;
            // Strip
            const usersMap = users();
            const items = usersMap.map(u => {
                const userStories = stories.filter(s => s.by === u.username);
                const hasNew = userStories.length > 0;
                const pfp = u.pfp || avatarFallback(u.name);
                return `<div class='story'><div class='ring ${hasNew ? 'new' : ''}' data-user='${u.username}' onclick='openStory("${u.username}")'><img src='${pfp}' alt='${u.name}'/></div><small>${u.name.split(' ')[0]}</small></div>`;
            }).join('');
            qs('#storiesStrip').innerHTML = items;
        }

        // Add story
        qs('#addStory').addEventListener('change', async (e) => {
            const onlyAdmins = localStorage.getItem('ktm_stories_only_admin') === '1';
            const canPost = !onlyAdmins || ['admin', 'leader'].includes(currentUser.role);
            if (!canPost) { alert('Only Admin/Leader can post stories right now.'); return; }
            const f = e.target.files?.[0]; if (!f) return;
            const url = await readFileAsDataURL(f);
            const caption = prompt('Caption (optional)') || '';
            const arr = getStories();
            arr.push({ id: R.id(), by: currentUser.username, name: currentUser.name, media: url, cap: caption, at: Date.now() });
            saveStories(arr);
            renderStoriesStrip();
            alert('Story added for 24 hours ‚úÖ');
            e.target.value = '';
        });

        // Open story viewer (S3 ‚Äì tap left/right)
        window.openStory = function (username) {
            const stories = getStories().filter(s => s.by === username);
            if (!stories.length) return;
            storyIndex = 0;
            qs('#viewer').classList.add('active');
            showStory(stories, storyIndex);
            // Tap areas
            qs('#tapL').onclick = () => { storyIndex = (storyIndex - 1 + stories.length) % stories.length; showStory(stories, storyIndex); };
            qs('#tapR').onclick = () => { storyIndex = (storyIndex + 1) % stories.length; showStory(stories, storyIndex); };
            qs('#viewerClose').onclick = () => { qs('#viewer').classList.remove('active'); };
        }

        function showStory(list, idx) {
            const s = list[idx];
            qs('#viewerImg').src = s.media;
            qs('#viewerCap').textContent = s.cap || `${s.name}`;
        }

        // Admin & misc observers
        const obs = new MutationObserver(() => { if (!qs('#page-admin').classList.contains('hidden')) renderAdmin(); });
        obs.observe(qs('#page-admin'), { attributes: true });

        // Quick links
        qs('#gotoEvents').addEventListener('click', () => switchTab('events'));

    </script>
</body>

</html>