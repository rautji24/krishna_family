<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Krishna Team ‚Ä¢ Community (Online)</title>
    <style>
        :root {
            --indigo: #3b2cff;
            --teal: #08bdbd;
            --gold: #ffd166;
            --royal: #2b50ff;
            --silver: #c0c7d6;
            --purple: #8a7cfb;
            --grey: #e9edf5;
            --text: #101828;
            --muted: #667085;
            --bg: #f6f8fb;
            --card: #ffffff;
            --shadow: 0 10px 30px rgba(16, 24, 40, .08);
            --radius: 16px;
        }

        [data-theme="dark"] {
            --bg: #0e1320;
            --card: #121a2b;
            --text: #e6e9f2;
            --muted: #9aa4b2;
            --grey: #1a2235;
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            font-family: Poppins, Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.45
        }

        header {
            background: #0c1028;
            color: #fff;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 10px 30px rgba(16, 24, 40, .08)
        }

        header .overlay {
            padding: 18px 20px
        }

        .wrap {
            max-width: 1100px;
            margin: 0 auto;
            padding: 20px
        }

        .card {
            background: var(--card);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(16, 24, 40, .08);
            padding: 18px;
            margin-bottom: 16px
        }

        .row {
            display: flex;
            gap: 16px;
            flex-wrap: wrap
        }

        .col {
            flex: 1 1 320px
        }

        .btn {
            appearance: none;
            border: 0;
            background: var(--royal);
            color: #fff;
            padding: 10px 14px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer
        }

        .btn.ghost {
            background: transparent;
            color: #fff;
            border: 1px solid #fff
        }

        .btn.grey {
            background: #eef2ff;
            color: #2b50ff
        }

        .btn.alt {
            background: #1f2937;
            color: #fff
        }

        .badge {
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 700;
            display: inline-block
        }

        .b-admin {
            background: #e8ecff;
            color: #2b50ff
        }

        .b-leader {
            background: #fff6db;
            color: #9a7700
        }

        .b-vice {
            background: #f1f3f8;
            color: #475467
        }

        .b-advisor {
            background: #efeaff;
            color: #5b3be1
        }

        .b-member {
            background: #f2f4f7;
            color: #475467
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 14px
        }

        .member {
            background: var(--card);
            border-radius: 14px;
            box-shadow: 0 10px 30px rgba(16, 24, 40, .08);
            padding: 14px
        }

        .avatar {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            object-fit: cover;
            display: block;
            background: #eef2ff
        }

        nav.tabs {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin: 12px 0
        }

        nav.tabs button {
            background: var(--card);
            border: 1px solid #2b3a59;
            color: var(--text);
            border-radius: 12px;
            padding: 8px 12px;
            cursor: pointer
        }

        nav.tabs button.active {
            background: linear-gradient(90deg, #f0f3ff, #ecfffb);
            border-color: #bfc6ff
        }

        [data-theme="dark"] nav.tabs button.active {
            background: #1a2440;
            color: #e6e9f2
        }

        .muted {
            color: var(--muted)
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #2b3a59;
            border-radius: 12px;
            background: var(--card);
            color: var(--text)
        }

        label {
            font-size: 12px;
            color: var(--muted);
            font-weight: 600;
            margin-bottom: 6px;
            display: block
        }

        .list {
            display: flex;
            flex-direction: column;
            gap: 12px
        }

        .notice {
            border: 1px solid #2b3a59;
            border-radius: 14px;
            padding: 12px
        }

        .notice .title {
            font-weight: 700
        }

        .notice .meta {
            font-size: 12px;
            color: var(--muted)
        }

        /* LOGIN FULLSCREEN */
        .auth {
            min-height: 100vh;
            display: grid;
            place-items: center;
            background: radial-gradient(1000px 520px at -10% -20%, #ecf0ff 20%, transparent), radial-gradient(1000px 520px at 110% 120%, #e6fffb 20%, transparent)
        }

        [data-theme="dark"] .auth {
            background: radial-gradient(1000px 520px at -10% -20%, #121a2b 20%, transparent), radial-gradient(1000px 520px at 110% 120%, #101826 20%, transparent)
        }

        .auth .box {
            max-width: 420px;
            width: 92%;
            background: var(--card);
            border-radius: 22px;
            box-shadow: 0 10px 30px rgba(16, 24, 40, .08);
            padding: 26px
        }

        .center {
            text-align: center
        }

        .title {
            font-size: 24px;
            font-weight: 800
        }

        /* Chat */
        .chat {
            height: 380px;
            overflow: auto;
            border: 1px solid #2b3a59;
            border-radius: 14px;
            background: var(--card);
            padding: 12px
        }

        .bubble {
            max-width: 70%;
            padding: 10px 12px;
            border-radius: 14px;
            margin: 6px 0;
            display: inline-block
        }

        .mine {
            background: #eef2ff;
            color: #1d2939;
            border-top-right-radius: 4px;
            float: right;
            clear: both
        }

        .theirs {
            background: #f8fafc;
            color: #1d2939;
            border-top-left-radius: 4px;
            float: left;
            clear: both
        }

        [data-theme="dark"] .mine {
            background: #24304d;
            color: #e6e9f2
        }

        [data-theme="dark"] .theirs {
            background: #1a2440;
            color: #e6e9f2
        }

        .bubble .name {
            font-weight: 700;
            font-size: 12px;
            margin-bottom: 4px
        }

        .bubble .time {
            font-size: 10px;
            color: #667085;
            margin-top: 6px
        }

        /* Birthday */
        .bday {
            border: 2px dashed #ffd166;
            background: linear-gradient(90deg, #fff8e6, #fff);
            border-radius: 16px;
            padding: 12px
        }

        [data-theme="dark"] .bday {
            background: linear-gradient(90deg, #2a2033, #1a1620);
            border-color: #ffd166
        }

        /* Stories */
        .stories {
            display: flex;
            gap: 10px;
            overflow: auto;
            padding: 8px 2px
        }

        .story {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px
        }

        .ring {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            padding: 2px;
            background: conic-gradient(var(--royal), var(--teal));
        }

        .ring.new {
            animation: pulse 1.6s infinite ease-in-out
        }

        .ring>img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            background: #fff
        }

        .story small {
            font-size: 12px;
            color: #475467
        }

        @keyframes pulse {
            0% {
                transform: scale(1)
            }

            50% {
                transform: scale(1.04)
            }

            100% {
                transform: scale(1)
            }
        }

        /* Story Viewer */
        .viewer {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50
        }

        .viewer.active {
            display: flex
        }

        .viewer .frame {
            position: relative;
            width: min(92vw, 420px);
            height: min(92vh, 740px);
            background: #000;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, .6)
        }

        .viewer img {
            width: 100%;
            height: 100%;
            object-fit: cover
        }

        .viewer .caption {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, transparent, rgba(0, 0, 0, .6));
            color: #fff;
            padding: 16px;
            font-size: 14px
        }

        .viewer .close {
            position: absolute;
            top: 8px;
            right: 8px
        }

        .viewer .tapL,
        .viewer .tapR {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 50%;
        }

        .viewer .tapL {
            left: 0
        }

        .viewer .tapR {
            right: 0
        }
    </style>

    <!-- Firebase v10 CDN (no build tools) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, addDoc, serverTimestamp, query, orderBy, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        // ----- YOUR CONFIG -----
        const firebaseConfig = {
            apiKey: "AIzaSyDm2RdsvOk8t146bdOVt3-TczKB3hvP3fg",
            authDomain: "krishna-team.firebaseapp.com",
            projectId: "krishna-team",
            // IMPORTANT: check bucket name in Firebase console.
            // Most projects use "<project-id>.appspot.com"
            storageBucket: "krishna-team.appspot.com",
            messagingSenderId: "1020803458909",
            appId: "1:1020803458909:web:8d0c19d5bd6ac00aaeaab4",
            measurementId: "G-SSMJBHNN95"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // ---------- UTIL ----------
        const qs = s => document.querySelector(s);
        const qsa = s => Array.from(document.querySelectorAll(s));
        const R = { id: () => Math.random().toString(36).slice(2, 10) };

        // ---------- STATE ----------
        let currentUser = null;
        let currentTab = 'dashboard';

        // ---------- THEME ----------
        const savedTheme = localStorage.getItem('ktm_theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);

        // ---------- AUTH (username + 5-char PIN like Y1275) ----------
        async function login() {
            const u = qs('#loginUser').value.trim().toLowerCase();
            const p = qs('#loginPass').value.trim();
            if (!/^[a-z0-9]+@ktm\.in$/.test(u)) { qs('#authErr').textContent = 'Use username like yash@ktm.in'; return; }
            if (!/^([A-Z]{1}[0-9]{4})$/.test(p)) { qs('#authErr').textContent = 'PIN = 1 capital letter + 4 digits (e.g., Y1275)'; return; }
            const ud = await getDoc(doc(db, 'users', u));
            if (!ud.exists()) { qs('#authErr').textContent = 'User not found.'; return; }
            const data = ud.data();
            if (data.pin !== p) { qs('#authErr').textContent = 'Wrong PIN.'; return; }
            currentUser = { username: u, ...data };
            if (qs('#rememberMe').checked) localStorage.setItem('ktm_session', u);
            startApp();
        }
        qs('#loginBtn').addEventListener('click', login);
        qs('#loginPass').addEventListener('keydown', e => { if (e.key === 'Enter') login(); });
        qs('#forgotPassBtn').addEventListener('click', () => alert('Forgot your PIN?\nPlease contact Yash (Admin) or Aman (Sachiv).'));

        // Auto session
        const remembered = localStorage.getItem('ktm_session');
        if (remembered) {
            const ud = await getDoc(doc(db, 'users', remembered));
            if (ud.exists()) { currentUser = { username: remembered, ...ud.data() }; startApp(); }
        }

        // ---------- RUN ONCE: seed users (then comment it) ----------
        async function seedUsersOnce() {
            const list = [
                { name: "Chetna", username: "chetna@ktm.in", role: "former_leader", badges: ["Former Leader"], pin: "C1234" },
                { name: "Yash", username: "yash@ktm.in", role: "admin", badges: ["Founder", "Admin", "Former Leader"], pin: "Y1275" },
                { name: "Muskan", username: "muskan@ktm.in", role: "leader", badges: ["Leader"], pin: "M1111" },
                { name: "Aman", username: "aman@ktm.in", role: "admin", badges: ["Admin", "Sachiv"], pin: "A2222" },
                { name: "Aditi", username: "aditi@ktm.in", role: "vice", badges: ["Vice Leader"], pin: "A3333" },
                { name: "Bhoomi", username: "bhoomi@ktm.in", role: "advisor", badges: ["Advisor"], pin: "B4444" },
                { name: "Kanha", username: "kanha@ktm.in", role: "member", badges: ["Member"], pin: "K5555" },
                { name: "Jatin", username: "jatin@ktm.in", role: "member", badges: ["Member"], pin: "J6666" },
                { name: "Manan", username: "manan@ktm.in", role: "member", badges: ["Member"], pin: "M7777" },
                { name: "Anshul", username: "anshul@ktm.in", role: "member", badges: ["Member"], pin: "A8888" },
                { name: "Laksh", username: "laksh@ktm.in", role: "member", badges: ["Member"], pin: "L9999" },
                { name: "Avni", username: "avni@ktm.in", role: "member", badges: ["Member"], pin: "A0000" },
                { name: "Veeranjany", username: "veeranjany@ktm.in", role: "member", badges: ["Member"], pin: "V1212" },
            ];
            for (const u of list) {
                await setDoc(doc(db, 'users', u.username), { name: u.name, role: u.role, badges: u.badges, pin: u.pin, pfp: "", bio: "", dob: "", lang: "en" });
            }
            alert('Seeded users. Now comment out seedUsersOnce() in code.');
        }
        // seedUsersOnce(); // ‚Üê run once, then comment

        // ---------- APP ----------
        function startApp() {
            qs('#auth').classList.add('hidden');
            qs('#app').classList.remove('hidden');
            qs('#appHeader').classList.remove('hidden');
            qs('#helloName').textContent = currentUser.name;
            qs('#userMini').innerHTML = `
        <span class="badge b-admin" style="background:#23304d;color:#fff">${currentUser.name}</span>
        <button class="btn ghost" id="logoutBtn">Logout</button>
        <button class="btn alt" id="themeToggle">${document.documentElement.getAttribute('data-theme') === 'dark' ? 'Light' : 'Dark'} Mode</button>`;
            qs('#logoutBtn').addEventListener('click', () => { localStorage.removeItem('ktm_session'); location.reload(); });
            qs('#themeToggle').addEventListener('click', () => {
                const cur = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', cur); localStorage.setItem('ktm_theme', cur);
                qs('#themeToggle').textContent = (cur === 'dark' ? 'Light' : 'Dark') + ' Mode';
            });
            buildTabs();
            renderDashboard();
            renderMembers();
            initChat();
            renderProfile();
            initStories();
        }

        function buildTabs() {
            const base = [
                { id: 'dashboard', label: 'Dashboard' },
                { id: 'members', label: 'Members' },
                { id: 'chat', label: 'Chat' },
                { id: 'profile', label: 'My Profile' },
            ];
            if (['admin'].includes(currentUser.role)) base.push({ id: 'admin', label: 'Admin' });
            qs('#tabs').innerHTML = base.map(t => `<button data-tab='${t.id}' class='${currentTab === t.id ? "active" : ""}'>${t.label}</button>`).join('');
            qsa('#tabs button').forEach(b => b.addEventListener('click', () => switchTab(b.dataset.tab)));
        }

        function switchTab(id) {
            currentTab = id; buildTabs();
            qsa('main section').forEach(s => s.classList.add('hidden'));
            qs(`#page-${id}`).classList.remove('hidden');
            if (id === 'chat') initChat();
            if (id === 'members') renderMembers();
            if (id === 'profile') renderProfile();
            if (id === 'admin') renderAdmin();
        }

        // ---------- Dashboard (just birthdays placeholder) ----------
        function renderDashboard() {
            qs('#bdayText').textContent = 'No birthdays today. üéÇ'; // can move to Firestore meta later
        }

        // ---------- Members (realtime) ----------
        async function renderMembers() {
            onSnapshot(collection(db, 'users'), (s) => {
                const arr = []; s.forEach(d => arr.push({ username: d.id, ...d.data() }));
                qs('#membersGrid').innerHTML = arr.map(u => `
          <div class='member'>
            <img class='avatar' src='${u.pfp || avatarFallback(u.name)}' alt='${u.name}'/>
            <div style='margin-top:8px'><strong>${u.name}</strong></div>
            <div style='margin-top:6px'>${roleBadge(u.role, u.badges)}</div>
            <div class='muted' style='margin-top:6px'><code>${u.username}</code></div>
          </div>
        `).join('');
            });
        }
        function roleBadge(r, extra) {
            const map = { admin: 'b-admin', leader: 'b-leader', vice: 'b-vice', advisor: 'b-advisor', member: 'b-member', former_leader: 'b-member' };
            let html = `<span class="badge ${map[r] || 'b-member'}">${{ admin: 'Admin', leader: 'Leader', vice: 'Vice Leader', advisor: 'Advisor', member: 'Member', former_leader: 'Former Leader' }[r] || 'Member'}</span>`;
            (extra || []).forEach(b => html += ` <span class="badge b-member">${b}</span>`); return html;
        }
        function avatarFallback(name) {
            const initials = name.split(' ').map(x => x[0]).slice(0, 2).join('').toUpperCase();
            const svg = encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#dfe4ff"/><stop offset="100%" stop-color="#d7fff6"/></linearGradient></defs><rect rx="32" ry="32" width="64" height="64" fill="url(#g)"/><text x="50%" y="54%" text-anchor="middle" font-family="Inter,Arial" font-size="26" fill="#1d2939">${initials}</text></svg>`);
            return `data:image/svg+xml,${svg}`;
        }

        // ---------- Chat (realtime) ----------
        let chatUnsub = null;
        function initChat() {
            if (chatUnsub) chatUnsub();
            const qRef = query(collection(db, 'messages'), orderBy('at', 'asc'));
            chatUnsub = onSnapshot(qRef, snap => {
                const box = qs('#chatBox');
                box.innerHTML = Array.from(snap.docs).map(d => {
                    const m = d.data(); const mine = m.by === currentUser.username; const cls = mine ? 'mine' : 'theirs';
                    const name = mine ? 'You' : m.name;
                    const t = m.at?.toDate ? m.at.toDate() : new Date();
                    return `<div class='bubble ${cls}'><div class='name'>${name}</div>${m.text}<div class='time'>${t.toLocaleTimeString()}</div></div>`
                }).join('');
                box.scrollTop = box.scrollHeight;
            });
        }
        qs('#sendMsg').addEventListener('click', sendMsg);
        qs('#chatInput').addEventListener('keydown', e => { if (e.key === 'Enter') sendMsg(); });
        // emoji bar
        (function injectEmojis() {
            const emojis = ['‚ú®', 'üôè', 'üíô', 'üôÇ', 'ü§î', 'üòè', 'ü•≤'];
            qs('#emojiArea').innerHTML = `<button class="btn grey" id="emojiBtn" type="button">Emoji</button><div id="emojiPicker" class="hidden" style="display:flex;gap:8px;flex-wrap:wrap;margin:6px 0"></div>`;
            const p = qs('#emojiPicker'); emojis.forEach(e => { const b = document.createElement('button'); b.className = 'btn grey'; b.textContent = e; b.dataset.emoji = e; p.appendChild(b); b.onclick = () => { qs('#chatInput').value += e; p.classList.add('hidden'); qs('#chatInput').focus(); }; });
            qs('#emojiBtn').onclick = () => p.classList.toggle('hidden');
        })();
        async function sendMsg() {
            const text = qs('#chatInput').value.trim(); if (!text) return;
            await addDoc(collection(db, 'messages'), { by: currentUser.username, name: currentUser.name, text, at: serverTimestamp() });
            qs('#chatInput').value = '';
        }

        // ---------- Profile (Firestore + Storage) ----------
        async function renderProfile() {
            qs('#pName').textContent = currentUser.name;
            qs('#pRole').innerHTML = roleBadge(currentUser.role, currentUser.badges);
            qs('#pBio').value = currentUser.bio || '';
            qs('#pDob').value = currentUser.dob || '';
            qs('#pLang').value = currentUser.lang || 'en';
            qs('#pfp').src = currentUser.pfp || avatarFallback(currentUser.name);
        }
        qs('#pfpUpload').addEventListener('change', async (e) => {
            const f = e.target.files?.[0]; if (!f) return;
            const ref = sRef(storage, `users/${currentUser.username}/pfp_${Date.now()}.jpg`);
            await uploadBytes(ref, f);
            const url = await getDownloadURL(ref);
            await updateDoc(doc(db, 'users', currentUser.username), { pfp: url });
            currentUser.pfp = url; renderProfile();
            // members list auto-update ho jayegi (realtime)
        });
        qs('#saveProfile').addEventListener('click', async () => {
            await updateDoc(doc(db, 'users', currentUser.username), {
                bio: qs('#pBio').value.trim(),
                dob: qs('#pDob').value.trim(),
                lang: qs('#pLang').value
            });
            alert('Profile saved ‚úÖ');
        });

        // ---------- Stories (24h, realtime) ----------
        function initStories() {
            const since = Date.now() - 24 * 60 * 60 * 1000;
            const qRef = query(collection(db, 'stories'), orderBy('at', 'asc'));
            onSnapshot(qRef, snap => {
                const fresh = Array.from(snap.docs).map(d => ({ id: d.id, ...d.data() })).filter(s => (s.at?.toDate ? s.at.toDate().getTime() : 0) > since);
                // latest per user
                const latestByUser = {}; fresh.forEach(s => latestByUser[s.by] = s);
                qs('#storiesStrip').innerHTML = Object.values(latestByUser).map(s => {
                    const name = s.name.split(' ')[0];
                    return `<div class='story'><div class='ring new' data-user='${s.by}' onclick='openStory("${s.by}")'><img src='${s.thumb || s.media}' alt='${name}'/></div><small>${name}</small></div>`;
                }).join('') || '<div class="muted">No stories yet.</div>';
            });
        }
        // add story
        qs('#addStory').addEventListener('change', async (e) => {
            const f = e.target.files?.[0]; if (!f) return;
            const ref = sRef(storage, `stories/${currentUser.username}/${Date.now()}_${f.name}`);
            await uploadBytes(ref, f);
            const url = await getDownloadURL(ref);
            await addDoc(collection(db, 'stories'), { by: currentUser.username, name: currentUser.name, media: url, thumb: url, cap: '', at: serverTimestamp() });
            alert('Story added for 24 hours ‚úÖ'); e.target.value = '';
        });
        // viewer + close fix
        window.openStory = async (username) => {
            const since = Date.now() - 24 * 60 * 60 * 1000;
            const qRef = query(collection(db, 'stories'), where('by', '==', username), orderBy('at', 'asc'));
            const snap = await getDocs(qRef);
            const list = []; snap.forEach(d => { const s = d.data(); const t = s.at?.toDate ? s.at.toDate().getTime() : 0; if (t > since) list.push({ id: d.id, ...s }); });
            if (!list.length) return;
            let idx = 0; const viewer = qs('#viewer'), img = qs('#viewerImg'), cap = qs('#viewerCap');
            const show = () => { img.src = list[idx].media; cap.textContent = list[idx].cap || list[idx].name; };
            show(); viewer.classList.add('active');
            qs('#tapL').onclick = () => { idx = (idx - 1 + list.length) % list.length; show(); };
            qs('#tapR').onclick = () => { idx = (idx + 1) % list.length; show(); };
            qs('#viewerClose').onclick = (e) => { e.stopPropagation(); viewer.classList.remove('active'); };
            viewer.onclick = (e) => { if (e.target === viewer) viewer.classList.remove('active'); };
        };

        // ---------- Admin (PIN reset) ----------
        async function renderAdmin() {
            if (currentUser.role !== 'admin') return;
            const cont = qs('#usersTable');
            const usersSnap = await getDocs(collection(db, 'users'));
            const rows = []; usersSnap.forEach(d => { const u = d.data(); rows.push(`<tr><td style='padding:6px'>${u.name}</td><td style='padding:6px'><code>${d.id}</code></td><td style='padding:6px'>${u.role}</td><td style='padding:6px'><button class='btn grey' data-reset='${d.id}'>Reset PIN</button></td></tr>`); });
            cont.innerHTML = `<div style='overflow:auto'><table style='width:100%;border-collapse:collapse'><thead><tr><th style='text-align:left;padding:6px'>Name</th><th style='text-align:left;padding:6px'>Username</th><th style='text-align:left;padding:6px'>Role</th><th style='text-align:left;padding:6px'>Actions</th></tr></thead><tbody>${rows.join('')}</tbody></table></div>`;
            cont.querySelectorAll('[data-reset]').forEach(btn => btn.onclick = async () => {
                const uname = btn.getAttribute('data-reset');
                const pin = prompt('Enter new 5-char PIN (e.g., Y1275)');
                if (!pin || !/^([A-Z]{1}[0-9]{4})$/.test(pin)) return alert('Invalid PIN format.');
                await updateDoc(doc(db, 'users', uname), { pin });
                alert('PIN updated ‚úÖ');
            });
        }
    </script>
</head>

<body>
    <!-- LOGIN -->
    <section id="auth" class="auth">
        <div class="box">
            <div class="center" style="margin-bottom:14px">
                <div class="title">Welcome to Krishna Team üíô</div>
                <div class="muted">Login with your <b>@ktm.in</b> username and 5-char PIN (e.g., <b>Y1275</b>).</div>
            </div>
            <div>
                <label>Username (e.g., yash@ktm.in)</label>
                <input id="loginUser" placeholder="username@ktm.in" autocomplete="username" />
            </div>
            <div style="margin-top:10px">
                <label>PIN (1 capital letter + 4 digits)</label>
                <input id="loginPass" placeholder="Y1275" autocomplete="current-password" />
            </div>
            <div style="display:flex;align-items:center;justify-content:space-between;margin-top:14px">
                <label style="display:flex;align-items:center;gap:8px"><input id="rememberMe" type="checkbox" /> <span
                        class="muted">Remember me</span></label>
                <button class="btn grey" id="forgotPassBtn" type="button">Forgot PIN?</button>
            </div>
            <button class="btn" style="width:100%;margin-top:12px" id="loginBtn">Login</button>
            <div id="authErr" class="muted" style="margin-top:10px;color:#b42318"></div>
        </div>
    </section>

    <!-- HEADER + APP -->
    <header id="appHeader" class="hidden">
        <div class="overlay">
            <div class="wrap" style="display:flex;gap:12px;align-items:center">
                <div style="font-weight:700">Krishna Team ‚Ä¢ Community</div>
                <div class="muted" style="font-size:14px">Memories ‚Ä¢ Celebration ‚Ä¢ Togetherness</div>
                <div style="margin-left:auto" id="userMini"></div>
            </div>
        </div>
    </header>

    <main id="app" class="wrap hidden">
        <nav class="tabs" id="tabs"></nav>

        <!-- DASHBOARD -->
        <section id="page-dashboard" class="card">
            <h3 style="margin:0 0 8px">Hello <span id="helloName">Friend</span>! üôÇ</h3>
            <div class="muted">This is your home for stories, chat and memories.</div>
            <div class="bday" id="bdayBox" style="margin-top:12px">
                <div id="bdayText"><strong>Birthdays</strong> will appear here.</div>
            </div>

            <!-- STORIES -->
            <div class="card" style="margin-top:12px">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                    <strong>Stories (24h)</strong>
                    <label class="btn grey" style="margin-right:6px"><input type="file" id="addStory" accept="image/*"
                            hidden />Add Story</label>
                </div>
                <div id="storiesStrip" class="stories"></div>
            </div>
        </section>

        <!-- MEMBERS -->
        <section id="page-members" class="card hidden">
            <h3 style="margin:0 0 12px">Members</h3>
            <div id="membersGrid" class="grid"></div>
        </section>

        <!-- CHAT -->
        <section id="page-chat" class="card hidden">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                <h3 style="margin:0">Group Chat ‚Ä¢ Krishna Team</h3>
                <span class="muted" id="typingState"></span>
            </div>
            <div id="chatBox" class="chat"></div>
            <div class="row" style="margin-top:10px">
                <div class="col" style="flex:1 1 auto"><input id="chatInput" placeholder="Write a message‚Ä¶" /></div>
                <div class="col" id="emojiArea" style="flex:0 0 auto"></div>
                <button class="btn" id="sendMsg">Send</button>
            </div>
        </section>

        <!-- ADMIN -->
        <section id="page-admin" class="card hidden">
            <h3 style="margin:0 0 10px">Admin Panel</h3>
            <div class="card">
                <strong>Users & PIN Reset</strong>
                <div id="usersTable" style="margin-top:8px"></div>
            </div>
        </section>

        <!-- PROFILE -->
        <section id="page-profile" class="card hidden">
            <h3 style="margin:0 0 12px">My Profile</h3>
            <div class="row">
                <div class="col" style="max-width:340px">
                    <img id="pfp" class="avatar" alt="avatar" />
                    <div style="margin-top:8px"><label class="btn grey"><input type="file" id="pfpUpload"
                                accept="image/*" hidden />Upload Photo</label></div>
                    <div style="margin-top:8px"><strong id="pName">‚Äî</strong></div>
                    <div class="muted" id="pRole">‚Äî</div>
                </div>
                <div class="col">
                    <label>Bio</label>
                    <textarea id="pBio" rows="4" placeholder="Write something about you‚Ä¶"></textarea>
                    <div style="display:flex;gap:8px;margin-top:8px">
                        <div style="flex:1">
                            <label>Birthday (DD-MM)</label>
                            <input id="pDob" placeholder="e.g., 11-09" />
                        </div>
                        <div style="flex:1">
                            <label>Language</label>
                            <select id="pLang">
                                <option value="en">English</option>
                                <option value="hi">Hindi</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn" style="margin-top:10px" id="saveProfile">Save Profile</button>
                </div>
            </div>
        </section>
    </main>

    <!-- STORY VIEWER -->
    <div id="viewer" class="viewer">
        <div class="frame">
            <img id="viewerImg" alt="story" />
            <div class="caption" id="viewerCap"></div>
            <button class="btn ghost close" id="viewerClose" type="button">Close</button>
            <div class="tapL" id="tapL"></div>
            <div class="tapR" id="tapR"></div>
        </div>
    </div>
</body>

</html>